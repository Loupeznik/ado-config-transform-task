# ADO Config Transform Task - Copilot Instructions

## Project Overview

This repository contains an Azure DevOps (ADO) configuration transformation task that enables automated transformation of configuration files across multiple formats. The task is designed to be deployed as a VSIX extension to the Azure DevOps marketplace.

### Supported File Types

- **JSON**: Configuration files like `appsettings.json` for .NET applications âœ… Implemented
- **YAML**: Helm values files, Kubernetes configurations, and other YAML-based configs âœ… Implemented  
- **Flat files**: Environment files (`.env`), properties files, and other key-value pair formats âœ… Implemented
- **XML**: Database publish profiles, .NET Framework application configurations ðŸš§ Planned (type defined, implementation pending)
- **TOML**: Planned future support for TOML configuration files ðŸš§ Planned

## Architecture

### Project Structure

```
src/
â”œâ”€â”€ ConfigTransformTask/           # Main task implementation
â”‚   â”œâ”€â”€ index.ts                  # Entry point and orchestration
â”‚   â”œâ”€â”€ task.json                 # Azure DevOps task definition
â”‚   â”œâ”€â”€ package.json              # Node.js dependencies
â”‚   â”œâ”€â”€ tsconfig.json            # TypeScript configuration
â”‚   â”œâ”€â”€ helpers/
â”‚   â”‚   â””â”€â”€ fileHelpers.ts       # File validation utilities
â”‚   â”œâ”€â”€ transformations/         # Transformation logic by file type
â”‚   â”‚   â”œâ”€â”€ json.ts             # JSON transformation logic âœ…
â”‚   â”‚   â”œâ”€â”€ yaml.ts             # YAML transformation logic âœ…
â”‚   â”‚   â”œâ”€â”€ flat.ts             # Flat file transformation logic âœ…
â”‚   â”‚   â””â”€â”€ xml.ts              # XML transformation logic ðŸš§ (not yet implemented)
â”‚   â””â”€â”€ tests/                  # Test files
â”‚       â”œâ”€â”€ _suite.ts           # Test suite configuration
â”‚       â””â”€â”€ flat_success.ts     # Flat file transformation tests
â”œâ”€â”€ vss-extension.json          # Azure DevOps extension manifest
â”œâ”€â”€ overview.md                 # Extension marketplace description
â””â”€â”€ Images/                     # Extension icons and screenshots
```

### Key Components

1. **Main Entry Point** (`index.ts`): Orchestrates the transformation process based on file type
2. **File Helpers** (`helpers/fileHelpers.ts`): Validates file existence and format compatibility
3. **Transformation Modules**: Type-specific transformation logic in the `transformations/` directory
4. **Task Definition** (`task.json`): Defines inputs, outputs, and metadata for Azure DevOps

### Core Workflow

1. Read input parameters (file path, file type, transformations, separator)
2. Validate file existence and format compatibility
3. Route to appropriate transformation module based on file type
4. Apply transformations using JSON-formatted transformation rules
5. Write transformed content back to the target file

## Development Setup

### Prerequisites

- Node.js 20.x or higher
- npm package manager
- TypeScript 4.6.3 or compatible version
- tfx-cli for VSIX packaging (for deployment)

### Installation

```bash
cd src/ConfigTransformTask
npm install
```

### Build Process

```bash
# Compile TypeScript
npm run build

# Build VSIX package (from src/ directory)
tfx extension create --manifest-globs vss-extension.json
```

### Manual Testing

The task can be tested locally by setting environment variables and running the compiled JavaScript:

**PowerShell (Windows):**
```powershell
cd src/ConfigTransformTask

# Set environment variables for task inputs
$env:INPUT_TargetPath="path/to/config/file"
$env:INPUT_FileType="json|yaml|flat|xml"
$env:INPUT_Transformations='{"key":"value","another":"newvalue"}'
$env:INPUT_Separator="=" # For flat files only

# Compile and run
npm run build
node dist/index.js
```

**Bash (Linux/macOS):**
```bash
cd src/ConfigTransformTask

# Set environment variables for task inputs
export INPUT_TargetPath="path/to/config/file"
export INPUT_FileType="json|yaml|flat|xml"
export INPUT_Transformations='{"key":"value","another":"newvalue"}'
export INPUT_Separator="=" # For flat files only

# Compile and run
npm run build
node dist/index.js
```

## Testing Strategy

### Current Test Setup

- Test framework: Mocha with Azure DevOps task mock testing library
- Test location: `src/ConfigTransformTask/tests/`
- Note: The npm test script currently needs configuration

### Writing Tests

1. Create test files in the `tests/` directory
2. Use `azure-pipelines-task-lib/mock-test` for mocking Azure DevOps task environment
3. Test both successful transformations and error handling
4. Validate file content changes and task result reporting

### Test Categories

- **Unit Tests**: Individual transformation functions
- **Integration Tests**: End-to-end task execution with mock Azure DevOps environment
- **File Format Tests**: Validate parsing and serialization for each supported format

## Transformation Logic

### JSON Transformations

- Uses native JavaScript JSON parsing and stringification
- Supports nested object key transformations
- Maintains JSON structure and formatting conventions

### YAML Transformations

- Uses `js-yaml` library for parsing and serialization
- Preserves YAML structure and comments where possible
- Supports complex YAML features like anchors and references

### Flat File Transformations

- Supports configurable separators (`=` or `:`)
- Handles key-value pair parsing and replacement
- Preserves file structure and comments
- Supports adding new key-value pairs

### XML Transformations

- **Status**: Type defined but implementation pending
- Should handle XML namespaces and attributes appropriately
- Consider using libraries like `xmldom` or `xml2js` for parsing
- Follow established patterns from other transformation modules

## Code Style and Conventions

### TypeScript Configuration

- Strict TypeScript settings enabled
- Target ES2020 or compatible
- Module resolution: Node.js style

### Code Style

- Use Prettier for code formatting (configuration in `.prettierrc`)
- Follow TypeScript/JavaScript naming conventions
- Use meaningful variable and function names
- Include JSDoc comments for public APIs

### Error Handling

- Use Azure DevOps task library result reporting (`tl.setResult`)
- Provide descriptive error messages for troubleshooting
- Handle file system errors gracefully
- Validate inputs thoroughly before processing

## Extension Management

### Azure DevOps Marketplace

- Extension ID and publisher information in `vss-extension.json`
- Marketplace description in `overview.md`
- Icons and screenshots in `Images/` directory

### Versioning

- Follow semantic versioning (semver)
- Update version in both `package.json` and `vss-extension.json`
- Tag releases with git tags (format: `v*.*.*`)

### CI/CD Pipeline

- GitHub Actions workflow in `.github/workflows/build.yml`
- Automated build and VSIX creation on push to master
- Automated marketplace publishing on tagged releases
- Requires `PUBLISH_TOKEN` secret for marketplace publishing

## Future Extensibility

### Adding New File Types

1. Create new transformation module in `transformations/` directory
2. Add file type validation to `helpers/fileHelpers.ts`
3. Update main switch statement in `index.ts`
4. Add new file type to task definition (`task.json`)
5. Create corresponding tests

### TOML Support Implementation

When implementing TOML support:
- Add TOML parsing library dependency (e.g., `@iarna/toml`)
- Create `transformations/toml.ts` module
- Follow existing patterns from other transformation modules
- Add appropriate test coverage

## Debugging and Troubleshooting

### Common Issues

1. **File not found**: Verify file paths and existence
2. **Invalid JSON transformations**: Validate transformation JSON format
3. **Build failures**: Check TypeScript compilation errors and dependency versions
4. **Extension packaging**: Ensure all required files are included in VSIX

### Debug Techniques

- Use console logging with Azure DevOps task library logging methods
- Test transformations with minimal example files
- Validate JSON transformation strings before applying
- Use TypeScript compiler in watch mode for rapid iteration

## Contributing

### Code Review Guidelines

- Ensure all new file types follow established patterns
- Add comprehensive test coverage for new functionality
- Update documentation for new features
- Validate backwards compatibility with existing configurations

### Performance Considerations

- Handle large configuration files efficiently
- Minimize memory usage during transformations
- Consider streaming for very large files if needed
- Profile transformation performance for complex operations